---
title: "Reproducibility review of: Extraction of linear structures from digital terrain models using deep learning"
author: "Anita Graser \\orcid{0000-0001-5361-2885}, Daniel Nüst \\orcid{0000-0002-0024-5046}"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    toc: false
papersize: a4
header-includes:
  - |
    % https://tex.stackexchange.com/questions/445563/ieeetran-how-to-include-orcid-in-tex-pdf-with-pdflatex/445583 (works with pdflatex)
    \usepackage{scalerel}
    \usepackage{tikz}
    \usetikzlibrary{svg.path}
    \definecolor{orcidlogocol}{HTML}{A6CE39}
    \tikzset{
      orcidlogo/.pic={
        \fill[orcidlogocol] svg{M256,128c0,70.7-57.3,128-128,128C57.3,256,0,198.7,0,128C0,57.3,57.3,0,128,0C198.7,0,256,57.3,256,128z};
        \fill[white] svg{M86.3,186.2H70.9V79.1h15.4v48.4V186.2z}
                     svg{M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z     M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z}
                     svg{M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z};
      }
    }
    \newcommand\orcid[1]{\href{https://orcid.org/#1}{\raisebox{0.15 em}{\mbox{\scalerel*{
    \begin{tikzpicture}[yscale=-1, transform shape]
    \pic{orcidlogo};
    \end{tikzpicture}
    }{|}}}}}
    \definecolor{agileblue}{RGB}{0,77,155}
urlcolor: agileblue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```

```{r logo, eval=TRUE, echo=FALSE, message=FALSE, fig.align='center', out.width='0.3\\linewidth', fig.pos='H'}
temp <- tempfile(fileext = ".pdf")
download.file(url = "https://reproducible-agile.github.io/public/images/reproducible-AGILE-logo-square.pdf", destfile = temp)
knitr::include_graphics(temp)
```

This report is part of the reproducibility review at the AGILE conference.
For more information see [https://reproducible-agile.github.io/](https://reproducible-agile.github.io/).
This document is published on OSF at TODO OSF LINK HERE.
To cite the report use

> FULL REPORT CITATION HERE

# Reviewed paper

> TODO ADD FULL CITATION

# Summary

- Result of the reproduction
- main outcome or figure

\clearpage

# Reproducibility reviewer notes

Started with the anonymous repo at https://github.com/Bashirkazimi/agile-submission-2021 and the author-provided draft of the DASA section.

```{bash env, eval=FALSE, size="tiny"}
git clone https://github.com/Bashirkazimi/agile-submission-2021

# first try using my local Python and GDAL, but Python 3.8 does not have tensorflow-gpu available in the required old version
gdalinfo --version
#GDAL 3.2.1, released 2020/12/29

# install python3.5, dev needed for GDAL
# sudo add-apt-repository ppa:deadsnakes/ppa
# sudo apt install python3.5 python3.5-dev

# in agile-submission-2021
mkvirtualenv agile-010 -p python3.5 -r requirements.txt
# following commands all in the venv

pip install GDAL==3.2.1
```

Next, I downloaded and unzipped the data per instructions.

```{bash create_dataset, eval=FALSE, size="tiny"}
python create_dataset.py
```

Leads to an error

```txt
libcublas.so.9.0: cannot open shared object file: No such file or directory
```

So, let's check if I have a CIDA-compatible graphics card:

```bash
sudo lshw -C display

*-display                 
       description: VGA compatible controller
       product: UHD Graphics 620 (Whiskey Lake)
       vendor: Intel Corporation
       physical id: 2
       bus info: pci@0000:00:02.0
       version: 00
       width: 64 bits
       clock: 33MHz
       capabilities: pciexpress msi pm vga_controller bus_master cap_list rom
       configuration: driver=i915 latency=0
       resources: irq:150 memory:bb000000-bbffffff memory:60000000-7fffffff ioport:3000(size=64) memory:c0000-dffff
```

Problem: I don't have the right graphics card.

Author said it should be possible with `tensorflow-cpu`, so I create `requirements-cpu.txt` with `tensorflow-cpu` version `1.15.0`, the only one for version `1.x`.
Furthermore, I needed to move a file to a different folder.

```{bash cpu, eval=FALSE, size="tiny"}
pip uninstall tensorflow_gpu
pip install -r requirements-cpu.txt

mv data/dtms/test_labels.tif data/labels/
```

Need to make adjustments in `utils/utils.py` for my version of GDAL, later also in `HRNetBinary../evaluate.py`

```python
# instead of import gdal, gdalconst
from osgeo import gdal, gdalconst

# instead of import ogr, osr
from osgeo import ogr, osr
```

```{bash createdataset_cpu, eval=FALSE, size="tiny"}
python create_dataset.py
# a lot of output...
```

Creates a lot of `.tif` files in `data/test`.

```{bash tree, eval=FALSE, size="tiny"}
tree -L 2 --du -h data/
data/
├── [385M]  dtms
│   └── [385M]  test_dtm.tif
├── [124M]  labels
│   └── [124M]  test_labels.tif
└── [320K]  test
    ├── [ 52K]  filenames.txt
    ├── [132K]  x
    └── [132K]  y

 509M used in 5 directories, 3 files
```

Next step in the instructions, binary segmentation wit HRNet:

```{bash hrnet, eval=FALSE, size="tiny"}
cd HRNetBinarySegmentation
python evaluate.py --evaluation_file=evaluation_file.csv
# [..]
Total params: 6,459,588
Trainable params: 6,446,018
Non-trainable params: 13,570
# [..]
```

Takes some time to run...


```{bash, eval=FALSE, size="tiny"}
```

# Comments to the authors

- Mostly a good job with the instructions in the README - please always test your own instructions - the file `test_labels.tif` was at the wrong location in the seafile share
- Suggest to provide a small script or CLI command to download the dataset, or mention to which directory the downloaded files should be extracted (`<project root>/data/dtms` or `<project root>/dtms`?)
- Note the code you "borrowed" from <https://github.com/niecongchong/HRNet-keras-semantic-segmentation> does not have a license attached to it, so I assume you asked the original author explicitly for permission to republish the code under the MIT license

```{r, echo=FALSE, eval=FALSE, results='hide'}
# create ZIP of reproduction files and upload to OSF
library("zip")
library("here")

zipfile <- here::here("PATH/agile-reproreview-YEAR-NUMBER.zip")
file.remove(zipfile)
zip::zipr(zipfile,
          here::here("2020-018/files to add to the zip, if any"))

library("osfr") # See docs at https://docs.ropensci.org/osfr/
# OSF_PAT is in .Renviron in parent directory
# We cannot use osfr to create a new component (with osfr::osf_create_component(x = osfr::osf_retrieve_node("6k5fh"), ...) because that will set the storage location to outside Europe.

# retrieve project
project <- osfr::osf_retrieve_node("OSF ID")

# upload files
osfr::osf_upload(x = project,
                 conflicts = "overwrite",
                 path = c(list.files(here::here("PATH"),
                                     pattern = "agile-reproreview-.*(pdf$|Rmd$|zip$)",
                                     full.names = TRUE),
                          "COPYRIGHT"
                          )
                 )
```